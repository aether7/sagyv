{% extends "panel_control.html" %}
{% load static from staticfiles %}

{% block css %}
<style>
    .celda-header{
        text-align: center !important;
        vertical-align: middle !important;
    }
</style>
{% endblock %}

{% block content %}
    {% include "mensaje.html" %}

    <section id="liquidacion" class="panel-liquidacion"
        data-ng-app="liquidacionApp" data-ng-controller="LiquidacionController as liqCtrl">

        <section class="panel-busqueda">
            <label for="guias_despacho">Guía despacho</label>
            <select id="guias_despacho" data-ng-model="liqCtrl.idGuiaDespacho">
                {% for guia_despacho in guias_despacho %}
                <option value="{{ guia_despacho.id }}" data-id="{{ guia_despacho.id }}">{{ guia_despacho.numero }}</option>
                {% endfor %}
            </select>
            <button class="btn btn-primary" data-ng-click="liqCtrl.buscarGuia()">Buscar</button>
        </section>

        {% include "liquidacion/panel_cabecera.html" %}
        {% include "liquidacion/panel_detalle.html" %}
        {% include "liquidacion/seccion_venta.html" %}

        <h3>Guías</h3>
        <table id="tabla_ventas" class="table table-striped">
            <thead>
                <tr>
                    <th>Tipo</th>
                    <th>Número guía</th>
                    <th>Producto</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                <tr data-ng-show="liqCtrl.guias.propia.ventas.length">
                    {% verbatim %}
                    <td rowspan="{{ liqCtrl.guias.propia.rowspan }}">Propia</td>
                    {% endverbatim %}
                </tr>

                <tr data-ng-repeat="venta in liqCtrl.guias.propia.ventas">
                    {% verbatim %}
                    <td rowspan="{{ venta.productos.length + 1 }}"
                        data-ng-bind="venta.numero"></td>
                    {% endverbatim %}

                    <td data-ng-repeat="producto in venta.productos"
                        data-ng-bind="producto.nombre"></td>

                    <td data-ng-repeat="producto in venta.productos"
                        data-ng-bind="producto.monto | currency"></td>
                </tr>
                <!--
                <tr data-ng-show="liqCtrl.guias.propia.ventas.length">
                    {% verbatim %}
                    <td class="celda-header" rowspan="{{ liqCtrl.guias.propia.rowspan }}">Propia</td>
                    <td class="celda-header" rowspan="{{ liqCtrl.guias.propia.rowspan }}"
                        data-ng-bind="liqCtrl.ventas.propia.numero"></td>
                    {% endverbatim %}
                </tr>

                <tr data-ng-repeat="producto in liqCtrl.ventas.propia.productos">
                    <td data-ng-bind="producto.nombre"></td>
                    <td data-ng-bind="producto.total"></td>
                </tr>

                <tr data-ng-show="liqCtrl.ventas.lipigas.productos.length">
                    {% verbatim %}
                    <td rowspan="{{ liqCtrl.ventas.lipigas.productos.length + 1 }}">Lipigas</td>
                    <td rowspan="{{ liqCtrl.ventas.lipigas.productos.length + 1 }}"
                        data-ng-bind="liqCtrl.ventas.lipigas.numero"></td>
                    {% endverbatim %}
                </tr>

                <tr data-ng-repeat="producto in liqCtrl.ventas.lipigas.productos">
                    <td data-ng-bind="producto.nombre"></td>
                    <td data-ng-bind="producto.total"></td>
                </tr>
                -->
            </tbody>
        </table>

        <h3>Vouchers</h3>

        <table class="table table-bordered table-condensed">
            <thead>
                <tr>
                    <th>Tipo voucher</th>
                    <th>tarjeta</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                <tr data-ng-show="liqCtrl.vouchers.lipigas.tarjetas.length">
                    {% verbatim %}
                    <td rowspan="{{ liqCtrl.vouchers.lipigas.tarjetas.length + 1 }}"
                        class="celda-header ng-cloak">Lipigas</td>
                    {% endverbatim %}
                </tr>

                <tr data-ng-repeat="tarjeta in liqCtrl.vouchers.lipigas.tarjetas">
                    <td data-ng-bind="tarjeta.nombre"></td>
                    <td data-ng-bind="tarjeta.monto | currency"></td>
                </tr>

                <tr data-ng-show="liqCtrl.vouchers.transbank.tarjetas.length">
                    {% verbatim %}
                    <td rowspan="{{ liqCtrl.vouchers.transbank.tarjetas.length + 1 }}"
                        class="celda-header ng-cloak">Transbank</td>
                    {% endverbatim %}
                </tr>

                <tr data-ng-repeat="tarjeta in liqCtrl.vouchers.transbank.tarjetas">
                    <td data-ng-bind="tarjeta.nombre"></td>
                    <td data-ng-bind="tarjeta.monto | currency"></td>
                </tr>
            </tbody>
        </table>

        <h3>Cheques</h3>

        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Banco</th>
                    <th>N° Cheque</th>
                    <th>Monto</th>
                    <th>Fecha</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr data-ng-repeat="chk in liqCtrl.cheques">
                    <td data-ng-bind="chk.banco.nombre"></td>
                    <td data-ng-bind="chk.numero"></td>
                    <td data-ng-bind="chk.monto"></td>
                    <td data-ng-bind="chk.fecha | date:'yyyy-MM-d'"></td>
                    <td>
                        <a href data-ng-click="liqCtrl.removeCheque($index)">eliminar</a>
                    </td>
                </tr>
            </tbody>
        </table>

        <button class="btn btn-primary" data-modal="">Guardar</button>
        <button class="btn btn-default" data-modal="">VENTA GARANTIAS</button>

        <button class="btn btn-primary" data-modal=""
            data-ng-click="liqCtrl.cerrarLiquidacion()">CERRAR LIQUIDACIÓN</button>
    </section>
{% endblock %}

{% block js %}
<script src="{% static 'js/vendor/angular.min.js' %}"></script>
<script src="{% static 'js/plugins/typeahead.min.js' %}"></script>
<script src="{% static 'js/common_functions.js' %}"></script>
<script src="{% static 'js/liquidacion.bundle.js' %}"></script>

<script id="tpl_tabla_ventas" type="text/x-handlebars-template">
{% include "liquidacion/tpl_tabla_ventas.html" %}
</script>

<script>
    Handlebars.registerHelper('omitePrimero', function(arreglo){
        if(!Array.isArray(arreglo)){
            throw new TypeError('nos enviaron un elemento que no es arreglo');
        }

        return arreglo.slice(1);
    });
</script>

<script>
    App.urls.set("liquidacion:obtener_guia", "{% url 'liquidacion:obtener_guia' %}");
    App.urls.set("liquidacion:buscar_cliente", "{% url 'liquidacion:buscar_cliente' %}");
    App.urls.set("liquidacion:cerrar", "{% url 'liquidacion:cerrar' %}");
</script>
{% endblock %}
